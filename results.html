<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel — Placar da Turma (online-v3)</title>
  <link rel="stylesheet" href="style.css?v=online-v3" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="pair">BOVA11</div>
      <div class="meta"><strong>Painel do apresentador</strong> <span class="sep">•</span> <span class="ver">versão: online-v3</span></div>
    </header>
    <main class="grid single">
      <section class="action-card">
        <div class="flex">
          <h1>Placar da turma</h1>
          <button id="resetBtn" class="ghost" title="Zerar a votação">Zerar</button>
        </div>
        <div class="bars bigbars">
          <div class="bar">
            <span>Compraram</span>
            <div class="track"><div id="buyBar" class="fill" style="width:0%"></div></div>
            <span id="buyPct" class="big">0%</span>
          </div>
          <div class="bar">
            <span>Venderam</span>
            <div class="track"><div id="sellBar" class="fill sell" style="width:0%"></div></div>
            <span id="sellPct" class="big">0%</span>
          </div>
        </div>
        <p id="totals" class="status">Total: 0 (Comprar: 0 • Vender: 0)</p>
      </section>
    </main>
  </div>

<script>

const VERSION = "online-v3";
const NAMESPACE = "muka_4cbaf2d48db8";
const API_BASE = "https://black-field-8298.rodrigosauerbier.workers.dev";
const KEY_BUY = "comprar";
const KEY_SELL = "vender";
const RESET_TOKEN = "muka2025";

function api(path) {
  const url = API_BASE.replace(/\/$/, '') + path + (path.includes('?')?'&':'?') + '_=' + Date.now();
  return fetch(url, {mode:'cors', cache:'no-store'}).then(r=>r.json());
}
async function apiInit() { try { await api(`/init?ns=${encodeURIComponent(NAMESPACE)}&keys=${KEY_BUY},${KEY_SELL}`); } catch (e) {} }
async function apiHit(k) { return api(`/hit?ns=${encodeURIComponent(NAMESPACE)}&key=${encodeURIComponent(k)}`); }
async function apiGet(k) { return api(`/get?ns=${encodeURIComponent(NAMESPACE)}&key=${encodeURIComponent(k)}`); }
async function apiSet(k,v) { return api(`/set?ns=${encodeURIComponent(NAMESPACE)}&key=${encodeURIComponent(k)}&value=${v}`); }


function toNum(v){ const n = Number(v); return Number.isFinite(n)? n: 0; }

function render(buy,sell){
  const total = toNum(buy)+toNum(sell);
  const bp = total>0 ? Math.round(buy/total*100) : 0;
  const sp = total>0 ? 100-bp : 0;
  document.getElementById("buyBar").style.width=bp+"%";
  document.getElementById("sellBar").style.width=sp+"%";
  document.getElementById("buyPct").textContent=bp+"%";
  document.getElementById("sellPct").textContent=sp+"%";
  document.getElementById("totals").textContent=`Total: ${total} (Comprar: ${buy} • Vender: ${sell})`;
}
async function tick(){
  try {
    const [b,s] = await Promise.all([apiGet("comprar"), apiGet("vender")]);
    render(b.value ?? 0, s.value ?? 0);
  }catch(e){}
}
async function resetCounts(){
  const token = prompt("Token para zerar (pergunte ao apresentador):");
  if(!token || token !== RESET_TOKEN) return;
  await apiSet("comprar", 0);
  await apiSet("vender", 0);
  tick();
}
document.getElementById("resetBtn").onclick = resetCounts;

apiInit().then(tick);
setInterval(tick, 1200);
</script>
</body>
</html>
