<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Queda de 20% ‚Äî Decida r√°pido! (online-v3)</title>
  <link rel="stylesheet" href="style.css?v=online-v3" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="pair">BOVA11</div>
      <div class="meta">
        <span id="clock">00:10</span>
        <span class="sep">‚Ä¢</span>
        <span>Queda inicial: -20%</span>
        <span class="sep">‚Ä¢</span>
        <span class="ver">vers√£o: online-v3</span>
      </div>
    </header>

    <main class="grid">
      <section class="chart-card">
        <img src="chart.png?v=online-v3" alt="gr√°fico" class="chart-img"/>
      </section>

      <section class="action-card">
        <h1>O mercado despencou 20%!</h1>
        <p>Decida em <strong>10 segundos</strong>: <strong>Comprar</strong> (aproveitar a queda) ou <strong>Vender</strong> (proteger capital).</p>
        <div id="netwarn" class="warn" style="display:none"></div>
        <div class="cta">
          <button id="buyBtn" class="buy">Comprar</button>
          <button id="sellBtn" class="sell">Vender</button>
        </div>
        <p id="status" class="status"></p>
        <div class="divider"></div>
        <h2>Placar da turma</h2>
        <div class="bars">
          <div class="bar">
            <span>Compraram</span>
            <div class="track"><div id="buyBar" class="fill" style="width:0%"></div></div>
            <span id="buyPct">0%</span>
          </div>
          <div class="bar">
            <span>Venderam</span>
            <div class="track"><div id="sellBar" class="fill sell" style="width:0%"></div></div>
            <span id="sellPct">0%</span>
          </div>
        </div>
        <p class="small">Abra o <a href="results.html?v=online-v3" target="_blank">Painel do Apresentador</a> para projetar o placar.</p>
      </section>
    </main>
  </div>

<script>

const VERSION = "online-v3";
const NAMESPACE = "muka_7d832cb81995";
const API_BASE = "https://YOUR-SUBDOMAIN.workers.dev";
const KEY_BUY = "comprar";
const KEY_SELL = "vender";
const RESET_TOKEN = "muka2025";

function api(path) {
  const url = API_BASE.replace(/\/$/, '') + path + (path.includes('?')?'&':'?') + '_=' + Date.now();
  return fetch(url, {mode:'cors', cache:'no-store'}).then(r=>r.json());
}
async function apiInit() { try { await api(`/init?ns=${encodeURIComponent(NAMESPACE)}&keys=${KEY_BUY},${KEY_SELL}`); } catch (e) {} }
async function apiHit(k) { return api(`/hit?ns=${encodeURIComponent(NAMESPACE)}&key=${encodeURIComponent(k)}`); }
async function apiGet(k) { return api(`/get?ns=${encodeURIComponent(NAMESPACE)}&key=${encodeURIComponent(k)}`); }
async function apiSet(k,v) { return api(`/set?ns=${encodeURIComponent(NAMESPACE)}&key=${encodeURIComponent(k)}&value=${v}`); }


// util
function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
function msg(m){ document.getElementById("status").textContent = m; }
function warn(m){ const el = document.getElementById("netwarn"); el.style.display = "block"; el.textContent = m; }

// rel√≥gio
const DECISION_SECONDS = 10;
let seconds = DECISION_SECONDS;
function renderClock(){ document.getElementById("clock").textContent = "00:" + (seconds<10? "0"+seconds: seconds); }
renderClock();
const t = setInterval(()=>{ seconds--; renderClock(); if(seconds<=0){ clearInterval(t); disable(); msg("‚è±Ô∏è Tempo esgotado!"); } },1000);

function disable(){ document.getElementById("buyBtn").disabled=true; document.getElementById("sellBtn").disabled=true; }

async function vote(kind){
  disable();
  try {
    await apiHit(kind === "comprar" ? KEY_BUY : KEY_SELL);
    msg(kind==="comprar" ? "üü¢ Voc√™ escolheu COMPRAR." : "üî¥ Voc√™ escolheu VENDER.");
    refresh();
  } catch (e) {
    warn("Falha ao votar. Verifique o link do servidor (API_BASE) ou tente outra rede.");
  }
}

function renderBars(buy,sell){
  const total = toNum(buy)+toNum(sell);
  const bp = total>0 ? Math.round(buy/total*100) : 0;
  const sp = total>0 ? 100-bp : 0;
  document.getElementById("buyBar").style.width = bp + "%";
  document.getElementById("sellBar").style.width = sp + "%";
  document.getElementById("buyPct").textContent = bp + "%";
  document.getElementById("sellPct").textContent = sp + "%";
}
async function refresh(){
  try {
    const [b, s] = await Promise.all([apiGet(KEY_BUY), apiGet(KEY_SELL)]);
    renderBars(b.value ?? 0, s.value ?? 0);
  } catch (e) {}
}

apiInit().then(refresh);
document.getElementById("buyBtn").onclick = ()=>vote("comprar");
document.getElementById("sellBtn").onclick = ()=>vote("vender");
setInterval(refresh, 1200);
</script>
</body>
</html>
